define("block_actvtmodal/block_main",["exports","jquery","core/modal_factory","core/modal_events","core/ajax"],(function(_exports,_jquery,_modal_factory,_modal_events,_ajax){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_ajax=_interopRequireDefault(_ajax);var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}_exports.init=async(blockid,contextid,courseid,userid,canedit)=>{let str=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core/str"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("core/str")):Promise.resolve(_systemImportTransformerGlobalIdentifier["core/str"]));const bindEvents=(event,selector,func)=>{(0,_jquery.default)(document).off(event,selector).on(event,selector,func)};bindEvents("change","[name=config_modcm]",(function(){let configcm=[];(0,_jquery.default)(this).is(":checked")?configcm.push((0,_jquery.default)(this).val()):configcm=configcm.filter((x=>x!=(0,_jquery.default)(this).val())),(0,_jquery.default)("[name=config_disablecm]").val(configcm.join(","))}));const updateConfigType=async()=>{let $tr=(0,_jquery.default)("#configtypewrapper").find("table").find("tbody tr"),configtype={};$tr.each((function(index,elem){let $this=(0,_jquery.default)(elem);configtype[$this.find("[name=disabletype]").val()]={d:$this.find("[name=disabletype]").is(":checked"),o:$this.find("[name=overridetype]").is(":checked"),p:$this.find("[name=showpageheader]").is(":checked"),t:$this.find("[name=showtitle]").is(":checked"),a:$this.find("[name=showactivityheader]").is(":checked"),s:$this.find("[name=showsecondarynav]").is(":checked"),b:$this.find("[name=showblock]").is(":checked"),u:$this.find("[name=urlparams]").val()}})),(0,_jquery.default)("[name=config_disabletype]").val(JSON.stringify(configtype))};if(bindEvents("change","#configtypewrapper [type=checkbox]",(function(){updateConfigType()})),bindEvents("input","#configtypewrapper [type=text]",(function(){updateConfigType()})),(0,_jquery.default)("body").hasClass("editing"))return;let sitecss=(0,_jquery.default)("#sitecss").val();sitecss&&"null"!=sitecss||(sitecss="");let configjson=(0,_jquery.default)("#configjson").val();configjson&&"null"!=configjson||(configjson="{}"),configjson=JSON.parse(configjson||"{}");let showactivityheader=0===Object.keys(configjson).length||(!configjson.showactivityheader||0!=configjson.showactivityheader),showtitle=1==configjson.showtitle,showsecondarynav=1==configjson.showsecondarynav,showblock=1==configjson.showblock,showpageheader=1==configjson.showpageheader,css=configjson.css||"",types=JSON.parse(configjson.disabletype||"{}"),disabletypekeys=Object.keys(types),disabledtypes=[];disabletypekeys.forEach((key=>{types[key]&&types[key].d&&disabledtypes.push(key)}));let disablecm=configjson.disablecm?configjson.disablecm.split(","):[],active=!1;bindEvents("click.AM",'[id="courseindex"] a.courseindex-link, .course-content a.aalink, nav#courseindex a[data-for=cm_name]',(async function(e){if(active)return;active=!0,e.preventDefault();let href=(0,_jquery.default)(this).attr("href"),matches=href.match(/mod\/([^/]+)\/view.php\?id=(\d+)/);if(!matches)return void(window.location.href=href);let url=href,mod=matches[1],id=matches[2];if(disablecm.includes(id))return;if(disabledtypes.includes(mod))return;let config=types[mod];config||(config={}),config.o?(config.showtitle=config.t,config.showactivityheader=config.a,config.showsecondarynav=config.s,config.showblock=config.b,config.showpageheader=config.p):(config.showtitle=showtitle,config.showactivityheader=showactivityheader,config.showsecondarynav=showsecondarynav,config.showblock=showblock,config.showpageheader=showpageheader),config.u&&""!=config.u&&(config.u.startsWith("?")?url+=config.u:url+="&"+config.u);let activityModal=await _modal_factory.default.create({body:'<div class="position-absolute w-100 h-100 no-pointer bg-transparent"\n                         id="background-loading">\n                        <div class="d-flex h-100 align-items-center justify-content-center">\n                            <div class="spinner-border text-danger"\n                                 style="width: 3rem;\n                                        height: 3rem"\n                                 role="status">\n                                <span class="sr-only">Loading...</span>\n                            </div>\n                        </div>\n                    </div>',large:!0,show:!1,removeOnClose:!0,isVerticallyCentered:!0}),root=activityModal.getRoot();root.addClass("activitymodal"),root.find(".modal-dialog").addClass("modal-xl").removeClass("modal-lg");let data,$body=root.find(".modal-body");$body.addClass("overflow-hidden");let modalhidden=!1;root.find('[data-action="hide"]').on("click",(function(){root.attr("data-region","modal-container")})),root.off("click.modal").on("click.modal",(function(e){0===(0,_jquery.default)(e.target).closest(".modal-content").length&&(root.addClass("am-jelly-anim"),setTimeout((()=>{root.removeClass("am-jelly-anim")}),500))})),root.off(_modal_events.default.hidden).on(_modal_events.default.hidden,(async function(){if(activityModal.destroy(),(0,_jquery.default)("body").removeClass("modal-open"),active=!1,modalhidden=!0,data&&-1==data.overallcompletion)return;data&&1==data.withavailability&&window.location.reload();let newcmdata=await _ajax.default.call([{methodname:"block_actvtmodal_get_info",args:{courseid:courseid,cmid:id,userid:userid,completiononly:!0}}])[0];if(newcmdata.data){if(JSON.parse(newcmdata.data).overallcompletion!=data.overallcompletion){let card=await _ajax.default.call([{methodname:"block_actvtmodal_get_cm_html",args:{data:JSON.stringify({courseid:courseid,cmid:id,userid:userid})}}])[0];card.data||window.location.reload();let html=JSON.parse(card.data).html;(0,_jquery.default)('li.activity[data-id="'.concat(id,'"]')).replaceWith(html).trigger("click")}}})),root.off(_modal_events.default.shown),root.on(_modal_events.default.shown,(async function(){root.addClass("am-jelly-anim"),setTimeout((()=>{root.removeClass("am-jelly-anim")}),500),(0,_jquery.default)("body").addClass("modal-open"),root.attr("data-region","popup");let cmdata=await _ajax.default.call([{methodname:"block_actvtmodal_get_info",args:{courseid:courseid,cmid:id,userid:userid,completiononly:!1}}])[0];if(!cmdata.data)return;data=JSON.parse(cmdata.data),root.find(".modal-title").empty().addClass("w-100 d-flex align-items-center").append('\n                        <div id="am-ca-header-wrapper"\n                         class="d-flex align-items-center w-100">\n                            <div class="'.concat(data.activity.purpose,' activityiconcontainer activity-icon am-mr-2 smaller small">\n                                ').concat(data.activity.icon,'\n                                </div>\n                            <h5 class="h5 mb-0 clamp-1">').concat(data.activity.name,"</h5>\n                        </div>\n                        ").concat(canedit?'<a href="'.concat(M.cfg.wwwroot,"/course/mod.php?update=").concat(id,'" class="btn border-0" target="_blank"\n                         title="').concat(await str.get_string("edit","block_actvtmodal"),'">\n                            <i class="fa fa-pen"></i>\n                        </a>'):"",'\n                        <a href="').concat(url,'" class="btn border-0" title="').concat(await str.get_string("openpage","block_actvtmodal"),'">\n                            <i class="fa fa-external-link-alt"></i>\n                        </a>\n                        <button type="button" class="btn border-0 enterfullscreen"\n                         title="').concat(await str.get_string("expand","block_actvtmodal"),'">\n                            <i class="fa fa-expand"></i>\n                        </button>\n                        <button type="button" class="btn border-0 exitfullscreen"\n                         title="').concat(await str.get_string("narrow","block_actvtmodal"),'">\n                            <i class="fa fa-compress"></i>\n                        </button>\n                        ')),$body.addClass("p-0"),$body.append('<iframe src="'.concat(url,'" width="100%" frameborder="0" allowfullscreen class="d-none bg-white"></iframe>')),$body.removeClass("overflow-hidden");let timeoutInterval,clicklink,iframe=document.querySelector(".activitymodal iframe"),divloaded=!1,timeout=0,checkIframe=async()=>{if(timeout>15)return clearInterval(timeoutInterval),void(iframe&&iframe.classList.remove("d-none"));if(iframe){iframe.style.background="none";let contentWindow=iframe.contentWindow;if(!contentWindow)return void requestAnimationFrame(checkIframe);let contentDocument=iframe.contentDocument||iframe.contentWindow.document;if(contentDocument.querySelector("div")){if(divloaded=!0,clearInterval(timeoutInterval),!contentDocument.body.classList.contains("cmid-"+id))return activityModal.hide(),void(window.location.href=clicklink);iframe.classList.remove("d-none");let classes="am-embedactivity";config.showtitle||(classes+=" am-hidetitle"),config.showactivityheader||(classes+=" am-hideactivityheader"),config.showsecondarynav||(classes+=" am-hidesecondarynav"),config.showblock||(classes+=" am-hideblock"),config.showpageheader||(classes+=" am-hidepageheader"),contentDocument.body.classList.add(classes),""!=sitecss&&(contentDocument.head.innerHTML+="<style>"+sitecss+"</style>"),""!=css&&(contentDocument.head.innerHTML+="<style>"+css+"</style>"),(0,_jquery.default)(contentDocument.body).append('<div id="am-embed-activity-container">\n                                <a class="btn" href="'.concat(url,'"\n                                 title="').concat(await str.get_string("startpage","block_actvtmodal"),'">\n                                 <i class="fa fa-home"></i></a>\n                                </div>')),contentWindow.addEventListener("unload",(function(){iframe.classList.add("d-none bg-white"),timeout=0,requestAnimationFrame(checkIframe),timeoutInterval=setInterval((function(){return timeout+=1,timeout>15?(clearInterval(timeoutInterval),void(iframe&&iframe.classList.remove("d-none"))):modalhidden?(clearInterval(timeoutInterval),void(timeout=16)):void 0}),1e3)})),(0,_jquery.default)(contentDocument).off("click.AM",'a[href^="http"]').on("click.AM",'a[href^="http"]',(function(){clicklink=(0,_jquery.default)(this).attr("href")}))}else requestAnimationFrame(checkIframe)}else requestAnimationFrame(checkIframe)};requestAnimationFrame(checkIframe),timeoutInterval=setInterval((function(){if(timeout+=1,timeout>15)return clearInterval(timeoutInterval),void(iframe&&iframe.classList.remove("d-none"))}),1e3),iframe.addEventListener("load",(async function(){if($body.find("#am-ca-back-wrapper").remove(),timeout=0,!divloaded)return iframe.classList.add("d-none"),void requestAnimationFrame(checkIframe);let iframedoc=iframe.contentDocument||iframe.contentWindow.document;if(!iframedoc||!iframedoc.body.classList.contains("course-"+courseid))return iframe.classList.remove("d-none"),iframe.classList.add("bg-white"),void $body.append('<div id="am-ca-back-wrapper" class="w-100 position-absolute top-0">\n                                <a id="gobacktoactivity" class="btn am-float-right" href="javascript:void(0)"\n                                 title="'.concat(await str.get_string("startpage","block_actvtmodal"),'">\n                                 <i class="fa fa-home fa-1x"></i></a>\n                                </div>'));iframe.classList.remove("bg-white")})),$body.off("click","#gobacktoactivity").on("click","#gobacktoactivity",(function(e){e.preventDefault(),$body.find("iframe").replaceWith('<iframe src="'.concat(url,'" allowfullscreen class="border-0 w-100 d-none bg-white"></iframe>')),iframe=document.querySelector(".activitymodal iframe"),divloaded=!1,timeout=0,requestAnimationFrame(checkIframe),clearInterval(timeoutInterval),timeoutInterval=setInterval((function(){if(timeout+=1,timeout>15)return clearInterval(timeoutInterval),void(iframe&&iframe.classList.remove("d-none"))}),1e3)}))})),activityModal.show()})),bindEvents("click.AM",".activitymodal .exitfullscreen",(function(e){e.preventDefault(),(0,_jquery.default)(this).closest(".activitymodal").removeClass("fullscreen")})),bindEvents("click.AM",".activitymodal .enterfullscreen",(function(e){e.preventDefault(),(0,_jquery.default)(this).closest(".activitymodal").addClass("fullscreen")}))}}));

//# sourceMappingURL=block_main.min.js.map